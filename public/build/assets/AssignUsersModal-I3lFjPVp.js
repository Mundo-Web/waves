var Y=Object.defineProperty;var I=(n,e,s)=>e in n?Y(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var E=(n,e,s)=>(I(n,typeof e!="symbol"?e+"":e,s),s);import{m as i,r as c,R as t}from"./CreateReactScript-BRBWlRTV.js";import{M as C}from"./Modal-CYscrTZ-.js";import{I as R}from"./InputFormGroup-Bwc1l4v7.js";import{i as k,S as q}from"./Adminto-BQEdF9zl.js";import{T as x}from"./TippyButton-BFYLHq91.js";import{S as M,a as U}from"./SetSelectValue-DT66DheI.js";import{U as _}from"./Assigneds-2NW9N57f.js";class a{}E(a,"paginate",async e=>{const{result:s}=await i.Fetch("/api/payments/paginate",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});return s}),E(a,"byProject",async e=>{const{result:s}=await i.Fetch(`/api/payments/project/${e}`);return(s==null?void 0:s.data)??[]}),E(a,"save",async e=>{try{const{status:s,result:l}=await i.Fetch("/api/payments",{method:"POST",body:JSON.stringify(e)});if(!s)throw new Error((l==null?void 0:l.message)||"Ocurrio un error inesperado");return i.Notify.add({icon:"/assets/img/logo-login.svg",title:"Correcto",body:l.message,type:"success"}),!0}catch(s){return i.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:s.message,type:"danger"}),!1}}),E(a,"status",async({id:e,status:s})=>{try{const{status:l,result:u}=await i.Fetch("/api/payments/status",{method:"PATCH",body:JSON.stringify({id:e,status:s})});if(!l)throw new Error((u==null?void 0:u.message)??"Ocurrio un error inesperado");return i.Notify.add({icon:"/assets/img/logo-login.svg",title:"Correcto",body:u.message,type:"success"}),!0}catch(l){return i.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:l.message,type:"danger"}),!1}}),E(a,"delete",async e=>{try{const{status:s,result:l}=await i.Fetch(`/api/payments/${e}`,{method:"DELETE"});if(!s)throw new Error((l==null?void 0:l.message)??"Ocurrio un error inesperado");return i.Notify.add({icon:"/assets/img/logo-login.svg",title:"Correcto",body:l.message,type:"success"}),!0}catch(s){return i.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:s.message,type:"danger"}),!1}});const X=({can:n,dataLoaded:e,setDataLoaded:s,grid2refresh:l})=>{const u=c.useRef(),o=c.useRef(),g=c.useRef(),f=c.useRef(),y=c.useRef(),m=c.useRef(),[h,b]=c.useState([]),[w,N]=c.useState(!1),[S,P]=c.useState(Number(e==null?void 0:e.remaining_amount));c.useEffect(()=>{e.id&&A(),$(u.current).on("hidden.bs.modal",()=>{s({}),b([]),N(!1),o.current.value=null,g.current.value=null,f.current.value=null,m.current.value=null})},[e]);const A=async()=>{const r=await a.byProject(e==null?void 0:e.id);b(r),P(Number(e==null?void 0:e.remaining_amount)),g.current.value=(e==null?void 0:e.id)||null,$(u.current).modal("show")},B=async r=>{r.preventDefault();const p={id:o.current.value||void 0,payment_id:g.current.value,project_id:e.id,payment_type:f.current.value,amount:m.current.value,date:y.current.value};await a.save(p)&&(o.current.value=null,y.current.value=null,f.current.value=null,m.current.value=null,await j(),l.refresh())},j=async()=>{const r=await a.byProject(e.id),p=r.reduce((T,F)=>Number(T)+Number(F.amount),0),v={...e,total_payments:p,remaining_amount:e.cost-p};s(v),b(r)},D=async r=>{o.current.value=r.id,f.current.value=r.payment_type,m.current.value=r.amount,y.current.value=r.date||moment(r.created_at).format("YYYY-MM-DD"),P(Number(e==null?void 0:e.remaining_amount)+Number(r.amount)),N(!0)},O=async r=>{const{isConfirmed:p}=await q.fire({title:"Estas seguro de eliminar este pago?",text:"No podras revertir esto!",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});!p||!await a.delete(r)||(await j(),l.refresh())};return t.createElement(C,{modalRef:u,title:`Pagos de ${e==null?void 0:e.name} - S/.${e==null?void 0:e.cost}`,onSubmit:B,hideButtonSubmit:!0},t.createElement("div",{className:`row ${!n("projects","all","addpayment","editpayment")&&"d-none"}`},t.createElement("input",{ref:g,type:"hidden"}),t.createElement("input",{ref:o,type:"hidden"}),t.createElement(R,{eRef:f,label:"Concepto",col:"col-12",required:!0}),t.createElement(R,{eRef:y,type:"date",label:"Fecha",col:"col-md-7",required:!0}),t.createElement("div",{className:"form-group col-md-5"},t.createElement("label",null,"Monto ",t.createElement("b",{className:"text-danger"},"*")),t.createElement("div",{className:"input-group"},t.createElement("input",{ref:m,type:"number",className:"form-control",placeholder:`Max: ${S}`,min:0,max:S||0,step:.01}),t.createElement(k,{content:w?"Actualizar pago":"Agregar pago"},t.createElement("button",{className:"btn input-group-text btn-dark waves-effect waves-light",type:"submit"},t.createElement("i",{className:`fa ${w?"fa-save":"fa-plus"}`})))))),t.createElement("hr",{className:"mb-2 mt-0"}),t.createElement("table",{className:"table table-bordered table-sm table-responsive table-striped mb-2"},t.createElement("thead",null,t.createElement("tr",null,n("projects","all","editpayment","deletepayment")&&t.createElement("th",null),t.createElement("th",null,"Concepto"),t.createElement("th",null,"Fecha"),t.createElement("th",null,"Monto"))),t.createElement("tbody",null,h.map(r=>(r.date||(r.date=moment(r.created_at).format("YYYY-MM-DD")),r)).sort((r,p)=>new Date(r.date)-new Date(p.date)).map(r=>t.createElement("tr",{key:`project-payment-${r.id}`},n("projects","all","editpayment","deletepayment")&&t.createElement("td",null,t.createElement("div",{className:"d-flex align-items-center gap-1"},n("projects","all","editpayment")&&t.createElement(x,{title:"Editar pago",className:"btn btn-xs btn-soft-primary",type:"button",onClick:()=>D(r)},t.createElement("i",{className:"fa fa-pen"})),n("projects","all","deletepayment")&&t.createElement(x,{title:"Eliminar pago",className:"btn btn-xs btn-soft-danger",type:"button",onClick:()=>O(r.id)},t.createElement("i",{className:"fa fa-trash"})))),t.createElement("td",null,r.payment_type),t.createElement("td",null,moment(r.date).format("LL")),t.createElement("td",null,"S/.",r.amount))))),t.createElement("table",{className:"table table-bordered table-sm table-responsive table-striped mb-0",style:{width:"max-content",float:"right"}},t.createElement("tbody",null,t.createElement("tr",null,t.createElement("th",{colSpan:3,className:"text-end"},"Pagado"),t.createElement("td",null,"S/.",e==null?void 0:e.total_payments)),t.createElement("tr",null,t.createElement("th",{colSpan:3,className:"text-end"},"Por pagar"),t.createElement("td",null,"S/.",e==null?void 0:e.remaining_amount)))))},Z=({dataLoaded:n,setDataLoaded:e,grid2refresh:s})=>{var y;const l=c.useRef(),u=c.useRef(),o=c.useRef();c.useEffect(()=>{n.id&&g(),$(l.current).on("hidden.bs.modal",()=>{u.current.value=null,M(o.current,null,null),e({})})},[n]);const g=async()=>{const m=await _.byProject(n==null?void 0:n.id);u.current.value=(n==null?void 0:n.id)||null,M(o.current,m,"id","fullname"),$(l.current).modal("show")},f=async m=>{m.preventDefault();const h={project_id:u.current.value,users:$(o.current).val()};await _.massiveByProject(h)&&($(l.current).modal("hide"),s.refresh())};return t.createElement(C,{modalRef:l,title:"Asignar usuarios al proyecto",onSubmit:f},t.createElement("div",{id:"assign-users-container"},t.createElement("p",null,"Que usuarios deseas asignar al proyecto ",t.createElement("b",null,n==null?void 0:n.name)," de ",t.createElement("b",null,(y=n==null?void 0:n.client)==null?void 0:y.name)),t.createElement("input",{ref:u,type:"hidden"}),t.createElement(U,{eRef:o,label:"Usuarios a asignar",col:"col-12",dropdownParent:"#assign-users-container",searchAPI:"/api/users/paginate",searchBy:"fullname",multiple:!0})))};export{Z as A,X as P};
