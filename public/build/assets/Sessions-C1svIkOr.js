var Z=Object.defineProperty;var ee=(m,n,i)=>n in m?Z(m,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):m[n]=i;var F=(m,n,i)=>(ee(m,typeof n!="symbol"?n+"":n,i),i);import{S as te,B as ae,i as T,A as ne}from"./Adminto-3c-f_6jB.js";import{r as a,G as _,R as e,m as U,C as re,c as se}from"./CreateReactScript-CVY3HzKt.js";import{M as L}from"./Modal-CBdtmnYV.js";import{I as p}from"./InputFormGroup-CgbdyySZ.js";import{T as ce}from"./TextareaFormGroup-prMXhYrp.js";import{g as le}from"./google-K1CXqkDy.js";const ie={verifying:{icon:"fa fa-spinner fa-spin",text:"Verificando sesion...",color:"secondary"},qr:{icon:"mdi mdi-qrcode-scan",text:"Escanea el QR",color:"danger"},loading_screen:{icon:"fa fa-spinner fa-spin",text:"Cargando...",color:"secondary"},authenticated:{icon:"fa fa-check",text:"Sesion activa",color:"primary"},ready:{icon:"fa fa-check",text:"Sesion activa y lista",color:"success"},close:{icon:"fa fa-warning",text:"Sesion cerrada",color:"danger"}},oe=({modalRef:m,dataLoaded:n,onReady:i})=>{var w,k;const r=a.useRef();a.useRef();const[s,l]=a.useState("verifying"),{color:N,icon:b,text:S}=ie[s],[x,q]=a.useState(0),[o,C]=a.useState({}),A=`${_.APP_CORRELATIVE}-${n==null?void 0:n.id}`;a.useEffect(()=>{if(n&&s=="verifying"){const y=new URLSearchParams({session:A});let f=new EventSource(`${_.WA_URL}/api/session/verify?${y}`);f.onmessage=({data:h})=>{if(h=="ping")return console.log("Realtime active");const{status:W,qr:D,percent:d,info:R}=JSON.parse(h);switch(W){case"qr":l("qr"),$(r.current).empty(),new QRCode(r.current,{text:D,width:200,height:200,colorDark:"#343a40"});break;case"loading_screen":l("loading_screen"),q(d);break;case"authenticated":l("authenticated");break;case"ready":l("ready"),C(R),i({id:n.id,metadata:{name:R.pushname,email:R.me._serialized,phone:R.me.user}}),f.close();break;case"close":l("close"),f.close(),setTimeout(()=>{l("verifying")},5e3);break;default:f.close();break}},f.onerror=h=>{console.log("Realtime closed"),l("close"),f.close(),setTimeout(()=>{l("verifying")},5e3)}}},[s,n]);const P=async()=>{const{isConfirmed:y}=await te.fire({title:"Estas seguro?",text:"Se cerrara la sesion actual",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});y&&(await fetch(`${_.WA_URL}/api/session/${A}`,{method:"DELETE"}),U.Notify.add({icon:"/assets/img/logo-login.svg",title:"Operacion correcta",body:`Se cerro la sesion de ${(o==null?void 0:o.pushname)||"WhatsApp"}`}),C({}),l("verifying"))};return e.createElement("div",{ref:m,className:"modal fade","aria-hidden":"true","data-bs-backdrop":"static"},e.createElement("div",{className:"modal-dialog modal-sm modal-dialog-centered"},e.createElement("div",{className:"modal-content"},e.createElement("div",{className:"modal-body"},e.createElement("div",{className:"text-center"},e.createElement("button",{type:"button",className:"btn-close position-absolute top-0 end-0 me-2 mt-2","data-bs-dismiss":"modal","aria-label":"Close"}),e.createElement("i",{className:`${b} h1 text-${N} my-2 d-block`}),e.createElement("h4",{className:"mt-2"},S," ",s=="loading_screen"&&`[${x}%]`),e.createElement("div",{ref:r,id:"qr-code",className:`mt-3 text-center ${s=="qr"?"d-block":"d-none"}`}),s=="ready"&&e.createElement("div",{className:"d-block py-2"},e.createElement("b",null,o==null?void 0:o.pushname),e.createElement("br",null),e.createElement("span",{className:"text-muted"},(w=o==null?void 0:o.me)==null?void 0:w.user,"@",(k=o==null?void 0:o.me)==null?void 0:k.server)),s=="ready"&&e.createElement("button",{type:"button",className:"btn btn-danger my-2",onClick:P},"Cerrar sesion"))))))};class V extends ae{constructor(){super(...arguments);F(this,"path","sessions");F(this,"verify",async(i,r)=>{try{const{status:s,result:l}=await U.Fetch(`/api/${this.path}/${i}`);if(!s)throw new Error((l==null?void 0:l.message)??"Ocurrio un error al verificar la sesion");return!0}catch(s){return console.error(s.message),r&&U.Notify.add({icon:"/assets/img/icon.svg",title:"Error",body:s.message,type:"danger"}),!1}});F(this,"ping",async i=>{try{const{status:r,result:s}=await U.Fetch(`/api/${this.path}/ping`,{method:"POST",body:JSON.stringify(i)});if(!r)throw new Error((s==null?void 0:s.message)??"Ocurrio un error al enviar el ping");U.Notify.add({icon:"/assets/img/icon.svg",title:"Correcto",body:`El ping ha sido enviado correctamente a ${i.to}`,type:"success"})}catch(r){U.Notify.add({icon:"/assets/img/icon.svg",title:"Error",body:r.message,type:"danger"})}})}}const me=new V,ue=({onModalOpen:m,onPingModalOpen:n,onWhatsAppModalOpen:i,...r})=>{var b;const[s,l]=a.useState(null);a.useEffect(()=>{N()},[null]);const N=async(S=!1)=>{l(null);const x=await me.verify(r.id,S);l(x)};return e.createElement("div",{className:"card mb-0"},e.createElement("div",{className:"card-body widget-user",style:{width:"240px"}},e.createElement("div",{className:"d-flex align-items-center"},e.createElement("div",{className:"flex-grow-1 overflow-hidden"},e.createElement("h5",{className:"mt-0 mb-1 text-truncate"},s==null?e.createElement("i",{className:"mdi mdi-circle me-1 text-muted"}):e.createElement(e.Fragment,null,s?e.createElement("i",{className:"mdi mdi-circle me-1 text-success"}):e.createElement(T,{content:"Verificar"},e.createElement("i",{className:"mdi mdi-circle me-1 text-danger",style:{cursor:"pointer"},onClick:()=>N(!0)}))),r==null?void 0:r.name),e.createElement("p",{className:"text-muted mb-2 font-13 text-truncate"},((b=r==null?void 0:r.metadata)==null?void 0:b.email)??"-"),e.createElement("div",{className:"d-flex flex-wrap gap-1"},s&&e.createElement(T,{content:"Ping"},e.createElement("button",{className:"btn btn-xs btn-dark rounded-pill waves-effect",onClick:()=>n(r)},e.createElement("i",{className:"mdi mdi-signal-variant"}))),r.type=="WhatsApp"&&!s&&e.createElement(T,{content:"Escanear QR"},e.createElement("button",{className:"btn btn-xs btn-dark rounded-pill waves-effect",onClick:()=>i(r)},e.createElement("i",{className:"mdi mdi-qrcode-scan"}))),e.createElement(T,{content:"Editar"},e.createElement("button",{className:"btn btn-xs btn-primary rounded-pill waves-effect",onClick:()=>m(r)},e.createElement("i",{className:"mdi mdi-pencil"}))),e.createElement(T,{content:"Desactivar"},e.createElement("button",{className:"btn btn-xs btn-light rounded-pill waves-effect"},e.createElement("i",{className:"mdi mdi-toggle-switch text-success"}))))))))},O=new V,de=({sessions:m=[]})=>{const n=a.useRef(),i=a.useRef(),r=a.useRef(),s=a.useRef(),l=a.useRef(),N=a.useRef(),b=a.useRef(),S=a.useRef(),x=a.useRef(),q=a.useRef(),o=a.useRef(),C=a.useRef(),A=a.useRef(),P=a.useRef(),w=a.useRef(),k=a.useRef(),y=a.useRef(),f=a.useRef(),h=a.useRef(),[W,D]=a.useState(m),[d,R]=a.useState(null),[v,H]=a.useState(null),[Q,z]=a.useState(null),j=t=>{var c,u,g,E,I,M,G,B;switch(R((t==null?void 0:t.type)??null),q.current.value=(t==null?void 0:t.id)??"",o.current.value=(t==null?void 0:t.name)??"",C.current.value=(t==null?void 0:t.alias)??"",A.current.value=(t==null?void 0:t.description)??"",H(((c=t==null?void 0:t.metadata)==null?void 0:c.type)??"integration"),f.current.value="",h.current.value="",P.current.value="",w.current.value="",k.current.value="",y.current.value="",(u=t==null?void 0:t.metadata)==null?void 0:u.type){case"gmail":f.current.value=((g=t==null?void 0:t.metadata)==null?void 0:g.email)??"",h.current.value=((E=t==null?void 0:t.metadata)==null?void 0:E.password)??"";break;case"google":break;default:P.current.value=((I=t==null?void 0:t.metadata)==null?void 0:I.host)??"",w.current.value=((M=t==null?void 0:t.metadata)==null?void 0:M.port)??"",k.current.value=((G=t==null?void 0:t.metadata)==null?void 0:G.email)??"",y.current.value=((B=t==null?void 0:t.metadata)==null?void 0:B.password)??"";break}$(n.current).modal("show")},J=async t=>{t.preventDefault();const c={id:q.current.value||void 0,type:d,name:o.current.value,alias:C.current.value,description:A.current.value,metadata:{type:v}};switch(v){case"gmail":c.metadata.email=f.current.value,c.metadata.password=h.current.value;break;case"google":break;default:c.metadata.host=P.current.value,c.metadata.port=w.current.value,c.metadata.email=k.current.value,c.metadata.password=y.current.value;break}const u=await O.save(c);if(!u)return;const g=W.findIndex(E=>E.id===u.id);D(g!==-1?E=>{const I=[...E];return I[g]=u,I}:E=>[...E,u]),$(n.current).modal("hide")},K=t=>{R(t.type),l.current.value=t.id,s.current.textContent=t.name,t.type=="Email"?(N.current.value=t.metadata.email,b.current.value=""):(S.current.value=t.metadata.phone,x.current.value=""),$(i.current).modal("show")},Y=t=>{t.preventDefault();const c={from:l.current.value,to:d=="Email"?b.current.value:x.current.value};O.ping(c)},X=t=>{z(t),$(r.current).modal("show")};return e.createElement(e.Fragment,null,e.createElement("main",{className:"d-flex align-items-center justify-content-center gap-2",style:{height:"calc(100vh - 160px)"}},e.createElement("div",{className:"card btn btn-light waves-effect mb-0",onClick:()=>j(),style:{height:"130px"}},e.createElement("div",{className:"card-body widget-user"},e.createElement("div",{className:"d-flex align-items-center"},e.createElement("div",{className:"flex-grow-1 overflow-hidden"},e.createElement("i",{className:"mdi mdi-plus mdi-24px"}),e.createElement("span",{className:"d-block"},"Nueva cuenta"))))),W.map((t,c)=>e.createElement(ue,{key:c,onModalOpen:j,onPingModalOpen:K,onWhatsAppModalOpen:X,...t}))),e.createElement(L,{modalRef:n,title:`Agregar cuenta${d?` - ${d}`:""}`,hideFooter:!d,onSubmit:J},e.createElement("input",{ref:q,type:"hidden"}),e.createElement("div",{className:`${d?"d-none":"d-flex"} align-items-center gap-3 justify-content-center`,style:{minHeight:"240px"}},["Email","WhatsApp"].map((t,c)=>e.createElement("label",{key:c,className:"d-block position-relative btn btn-light text-center",style:{width:"120px"}},e.createElement("input",{className:"d-none position-absolute",type:"radio",name:"session_type",id:"",value:t,style:{left:"8px",top:"8px"},onChange:u=>R(u.target.value)}),e.createElement("img",{className:"d-block mx-auto mb-1",src:`/assets/img/${t}.svg`,alt:t,style:{width:"50px",aspectRatio:1,objectFit:"contain",objectPosition:"center"}}),e.createElement("span",null,t)))),e.createElement("div",{hidden:!d},e.createElement("div",{className:"row"},e.createElement(p,{eRef:o,label:"Nombre",col:"col-md-8",required:!0}),e.createElement(p,{eRef:C,label:"Alias",col:"col-md-4"}),e.createElement(ce,{eRef:A,label:"Descripcion",required:!0})),e.createElement("div",{hidden:d!="Email"},e.createElement("ul",{id:"email-types",className:"nav nav-pills navtab-bg nav-justified"},e.createElement("li",{className:"nav-item"},e.createElement("a",{href:"#email-integration","data-bs-toggle":"tab","aria-expanded":"false",className:`nav-link ${v==null||v=="integration"?"active":""}`},e.createElement("i",{className:"mdi mdi-email me-1"}),"Integracion")),e.createElement("li",{className:"nav-item"},e.createElement("a",{href:"#email-gmail","data-bs-toggle":"tab","aria-expanded":"true",className:`nav-link ${v=="gmail"?"active":""}`},e.createElement("i",{className:"mdi mdi-gmail me-1"}),"Gmail")),e.createElement(T,{content:"Proximamente"},e.createElement("li",{className:"nav-item"},e.createElement("a",{href:"#email-google","data-bs-toggle":"tab","aria-expanded":"false",className:`nav-link ${v=="google"?"active":""} disabled`},e.createElement("i",{className:"mdi mdi-google me-1"}),"Google")))),e.createElement("div",{className:"tab-content"},e.createElement("div",{className:`tab-pane ${v=="integration"?"active":""}`,id:"email-integration"},e.createElement("div",{className:"row"},e.createElement(p,{eRef:P,label:"Host",col:"col-md-8"}),e.createElement(p,{eRef:w,label:"Puerto",col:"col-md-4",type:"number"}),e.createElement(p,{eRef:k,label:"Correo"}),e.createElement(p,{eRef:y,label:"Contraseña"}))),e.createElement("div",{className:`tab-pane ${v=="gmail"?"active":""}`,id:"email-gmail"},e.createElement("blockquote",null,"Para obtener una contraseña de aplicación de Gmail acceda a este enlace: ",e.createElement("a",{href:"//myaccount.google.com/apppasswords",target:"_blank"},"myaccount.google.com/apppasswords")),e.createElement(p,{eRef:f,label:"Correo"}),e.createElement(p,{eRef:h,label:"Contraseña de aplicación"})),e.createElement("div",{className:`tab-pane text-center ${v=="google"?"active":""}`,id:"email-google"},e.createElement("p",null,"Necesitamos tu permiso para ",e.createElement("br",null),"acceder a tu correo electrónico. ",e.createElement("br",null),e.createElement("small",{className:"text-muted"},"No te preocupes, tus datos están seguros con nosotros.")),e.createElement("div",{className:"d-flex flex-column justify-content-center align-items-center gap-1"},e.createElement("button",{className:"btn btn-sm btn-primary",type:"button",onClick:()=>setTokenUUID(crypto.randomUUID())},"Ya he iniciado sesión"),e.createElement("button",{className:"btn btn-sm btn-white d-inline-flex align-items-center gap-1",type:"button",onClick:t=>{const c=window.open(googleAuthURI,"_blank"),u=Local.get("tokenUUID"),g=setInterval(()=>{const E=Local.get("tokenUUID");u!=E&&(clearInterval(g),c.close(),setTokenUUID())},[500])}},e.createElement("img",{src:le,alt:"",style:{width:"14px",height:"14px",objectFit:"contain",objectPosition:"center"}}),e.createElement("span",null,"Permitir acceso")))))))),e.createElement(L,{modalRef:i,title:"Ping",size:"sm",onSubmit:Y},e.createElement("input",{ref:l,type:"hidden"}),e.createElement("blockquote",null,"Envia un mensaje de prueba con ",e.createElement("b",{ref:s},"sodeword@gmail.com")),e.createElement("div",{hidden:d!="Email"},e.createElement(p,{eRef:N,label:"De:",disabled:!0}),e.createElement(p,{eRef:b,label:"Para:",type:"email"})),e.createElement("div",{hidden:d!="WhatsApp"},e.createElement(p,{eRef:S,label:"De:",type:"tel"}),e.createElement(p,{eRef:x,label:"Para:",type:"tel"}))),e.createElement(oe,{modalRef:r,dataLoaded:Q,onReady:async t=>{const c=O.save(t);c&&D(u=>u.map(g=>g.id==c.id?c:g))}}))};re((m,n)=>{se(m).render(e.createElement(ne,{...n,title:"Cuentas"},e.createElement(de,{...n})))});
